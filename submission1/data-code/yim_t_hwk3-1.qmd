---
title: "Homework 1"
subtitle: "Research Methods, Spring 2024"
author: "Taeyoung Yim"
format:
  pdf:
    output-file: "yim-t-hwk1-3"
    output-ext:  "pdf"
    header-includes:
      - \usepackage{float}
      - \floatplacement{table}{H}
---

```{r}
#| include: false

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, readr, readxl, hrbrthemes, fixest,
               scales, gganimate, gapminder, gifski, png, tufte, plotly, OECD,
               ggrepel, survey, foreign, devtools, pdftools, kableExtra, modelsummary,
               kableExtra)
```

```{r}
#| include: false
#| eval: true
cig.data <- read_csv("data/input/cdcdata.csv", col_names = TRUE)
cpi.data <- read_xlsx("data/input/cpidata.xlsx", skip = 11)


# Clean tobacco data --------------------------------------------------------------
cig.data <- cig.data %>%
  mutate(measure = case_when(
    SubMeasureDesc == "Average Cost per pack" ~ "cost_per_pack",
    SubMeasureDesc == "Cigarette Consumption (Pack Sales Per Capita)" ~ "sales_per_capita",
    SubMeasureDesc == "Federal and State tax as a Percentage of Retail Price" ~ "tax_percent",
    SubMeasureDesc == "Federal and State Tax per pack" ~ "tax_dollar",
    SubMeasureDesc == "Gross Cigarette Tax Revenue" ~ "tax_revenue",
    SubMeasureDesc == "State Tax per pack" ~ "tax_state"
  )) %>%
  select(state_abb = LocationAbbr, 
         state = LocationDesc, 
         Year, 
         value=Data_Value, 
         measure)
         
final.data <- pivot_wider(cig.data, 
                         id_cols = c("state","Year"),
                         names_from = "measure",
                         values_from = "value") %>%
  arrange(state, Year)



# Clean CPI data ----------------------------------------------------------
cpi.data <- pivot_longer(cpi.data, 
                         cols=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),
                         names_to="month",
                         values_to="index")
cpi.data <- cpi.data %>%
  group_by(Year) %>%
  summarize(index=mean(index, na.rm=TRUE))



# Form final dataset ------------------------------------------------------
# adjust to 2010 dollars
final.data <- final.data %>%
  left_join(cpi.data, by="Year") %>%
  mutate(price_cpi=cost_per_pack*(218/index))

write_tsv(final.data,"data/output/TaxBurden_Data.txt",append=FALSE,col_names=TRUE)
write_rds(final.data,"data/output/TaxBurden_Data.rds")

```

\newpage
# Summarize the Data
Answer the following based on the enrollment data:
\vspace{.2in}
\noindent 1. Present a bar graph showing the proportion of states with a change in their cigarette tax in each year from 1970 to 1985.<br>
```{r,  echo = FALSE}
# Filter data for the years 1970 to 1985
filtered_data <- final.data %>%
  filter(Year >= 1970 & Year <= 1985)

# Calculate the proportion of states with a change in cigarette tax for each year
tax_change_counts <- filtered_data %>%
  group_by(Year) %>%
  summarize(states_with_change = sum(!is.na(tax_dollar)))

total_states <- length(unique(filtered_data$state))

tax_change_counts <- tax_change_counts %>%
  mutate(proportion = states_with_change / total_states)

# Plotting
library(ggplot2)

ggplot(tax_change_counts, aes(x = factor(Year), y = proportion)) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(title = "Proportion of States with Cigarette Tax Changes (1970-1985)",
       x = "Year",
       y = "Proportion of States") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

```

\newpage
\vspace{.2in}
\noindent 2. Plot on a single graph the average tax (in 2012 dollars) on cigarettes and the average price of a pack of cigarettes from 1970 to 2018.<br>
```{r,  echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming final.data contains necessary information

# Filter data for the years 1970 to 2018
filtered_data <- final.data %>%
  filter(Year >= 1970 & Year <= 2018)

# Calculate average tax and average price for each year
average_tax <- filtered_data %>%
  group_by(Year) %>%
  summarize(avg_tax_2012 = mean(tax_dollar * (218 / index)))

average_price <- filtered_data %>%
  group_by(Year) %>%
  summarize(avg_price = mean(cost_per_pack))

# Combine the datasets
combined_data <- merge(average_tax, average_price, by = "Year")

# Plotting
ggplot(combined_data, aes(x = Year)) +
  geom_line(aes(y = avg_tax_2012, color = "Average Tax (2012 dollars)")) +
  geom_line(aes(y = avg_price, color = "Average Price of a Pack")) +
  scale_color_manual(values = c("Average Tax (2012 dollars)" = "blue", "Average Price of a Pack" = "red")) +
  labs(title = "Average Tax and Price of Cigarettes (1970-2018)",
       y = "Average Amount",
       color = "Variable") +
  theme_minimal()


```

\newpage
\vspace{.2in}
\noindent 3.Identify the 5 states with the highest increases in cigarette prices (in dollars) over the time period. Plot the average number of packs sold per capita for those states from 1970 to 2018.<br>
```{r,  echo = FALSE}
library(ggplot2)
library(dplyr)

# 1. Identify the 5 states with the highest increases in cigarette prices (in dollars) over the time period
price_increase <- final.data %>%
  filter(Year >= 1970 & Year <= 2018) %>%
  group_by(state) %>%
  summarize(price_increase = max(cost_per_pack) - min(cost_per_pack))

top_5_states <- price_increase %>%
  arrange(desc(price_increase)) %>%
  head(5)

# 2. Filter final data to include only the top 5 states
filtered_data <- final.data %>%
  filter(state %in% top_5_states$state)

# 3. Plot the average number of packs sold per capita for those states from 1970 to 2018
ggplot(filtered_data, aes(x = Year, y = sales_per_capita, group = state, color = state)) +
  geom_line() +
  labs(title = "Average Packs Sold Per Capita for Top 5 States with Highest Price Increases",
       x = "Year",
       y = "Average Packs Sold Per Capita",
       color = "State") +
  theme_minimal()

```

\newpage
\vspace{.2in}
\noindent 4.Identify the 5 states with the lowest increases in cigarette prices over the time period. Plot the average number of packs sold per capita for those states from 1970 to 2018.<br>
```{r,  echo = FALSE}
library(ggplot2)
library(dplyr)

# 1. Identify the 5 states with the lowest increases in cigarette prices (in dollars) over the time period
price_increase <- final.data %>%
  filter(Year >= 1970 & Year <= 2018) %>%
  group_by(state) %>%
  summarize(price_increase = max(cost_per_pack) - min(cost_per_pack))

bottom_5_states <- price_increase %>%
  arrange(price_increase) %>%
  head(5)

# 2. Filter final data to include only the bottom 5 states
filtered_data <- final.data %>%
  filter(state %in% bottom_5_states$state)

# 3. Plot the average number of packs sold per capita for those states from 1970 to 2018
ggplot(filtered_data, aes(x = Year, y = sales_per_capita, group = state, color = state)) +
  geom_line() +
  labs(title = "Average Packs Sold Per Capita for States with Lowest Price Increases",
       x = "Year",
       y = "Average Packs Sold Per Capita",
       color = "State") +
  theme_minimal()

```

\newpage
\vspace{.2in}
\noindent 5.Compare the trends in sales from the 5 states with the highest price increases to those with the lowest price increases.<br>
```{r,  echo = FALSE}
library(ggplot2)
library(dplyr)

# 1. Identify the 5 states with the highest and lowest price increases
price_increase <- final.data %>%
  filter(Year >= 1970 & Year <= 2018) %>%
  group_by(state) %>%
  summarize(price_increase = max(cost_per_pack) - min(cost_per_pack))

top_5_states <- price_increase %>%
  arrange(desc(price_increase)) %>%
  head(5)

bottom_5_states <- price_increase %>%
  arrange(price_increase) %>%
  head(5)

# 2. Filter final data to include only the top and bottom 5 states
filtered_top_data <- final.data %>%
  filter(state %in% top_5_states$state)

filtered_bottom_data <- final.data %>%
  filter(state %in% bottom_5_states$state)

# 3. Plot the average number of packs sold per capita for the top and bottom 5 states
ggplot() +
  geom_line(data = filtered_top_data, aes(x = Year, y = sales_per_capita, group = state, color = state), linetype = "solid") +
  geom_line(data = filtered_bottom_data, aes(x = Year, y = sales_per_capita) 

```

\newpage
# Estimate ATEs
Now let’s work on estimating a demand curve for cigarettes. Specifically, we’re going to estimate the price elasticity of demand for cigarettes. When explaining your findings, try to limit your discussion just to a couple of sentences.
\vspace{.2in}
\noindent 6.Focusing only on the time period from 1970 to 1990, regress log sales on log prices to estimate the price elasticity of demand over that period. Interpret your results.<br>
```{r,  echo = FALSE}
library(dplyr)
library(tidyr)
library(lmtest)

# Filter data for the time period from 1970 to 1990
filtered_data <- final.data %>%
  filter(Year >= 1970 & Year <= 1990)

# Log transformation of sales and prices
filtered_data <- filtered_data %>%
  mutate(log_sales = log(sales_per_capita),
         log_prices = log(cost_per_pack))

# Perform linear regression
lm_result <- lm(log_sales ~ log_prices, data = filtered_data)

# Extract elasticity coefficient
elasticity <- coef(lm_result)[2]

# Output results
summary(lm_result)

# Interpretation
cat("The estimated price elasticity of demand for cigarettes from 1970 to 1990 is", round(elasticity, 4), "\n")
cat("This indicates that a 1% increase in cigarette prices would lead to approximately a", round(elasticity * 100, 2), "% decrease in cigarette sales during this period.")

```

\vspace{.2in}
\noindent 7.Again limiting to 1970 to 1990, regress log sales on log prices using the total (federal and state) cigarette tax (in dollars) as an instrument for log prices. Interpret your results and compare your estimates to those without an instrument. Are they different? If so, why?<br>
```{r,  echo = FALSE}
library(dplyr)
library(lmtest)
library(AER)

# Filter data for the time period from 1970 to 1990
filtered_data <- final.data %>%
  filter(Year >= 1970 & Year <= 1990)

# Log transformation of sales, prices, and total cigarette tax
filtered_data <- filtered_data %>%
  mutate(log_sales = log(sales_per_capita),
         log_prices = log(cost_per_pack),
         log_tax = log(tax_dollar))

# Perform 2SLS regression using the total cigarette tax as an instrument for prices
iv_result <- ivreg(log_sales ~ log_prices | log_tax, data = filtered_data)

# Output results
summary(iv_result)

# Interpretation
cat("The estimated coefficient for log prices from the 2SLS regression is", round(coef(iv_result)[2], 4), "\n")
cat("This coefficient represents the estimated price elasticity of demand using the total cigarette tax as an instrument for prices.\n")

cat("Comparing to the estimates without an instrument, there may be differences due to endogeneity or omitted variable bias in the ordinary least squares (OLS) regression. By using an instrument for prices, the 2SLS regression helps address potential endogeneity issues and provides more reliable estimates of the price elasticity of demand for cigarettes.")

```

\vspace{.2in}
\noindent 8.Show the first stage and reduced-form results from the instrument.<br>
```{r,  echo = FALSE}
library(dplyr)
library(AER)

# Filter data for the time period from 1970 to 1990
filtered_data <- final.data %>%
  filter(Year >= 1970 & Year <= 1990)

# Log transformation of sales, prices, and total cigarette tax
filtered_data <- filtered_data %>%
  mutate(log_sales = log(sales_per_capita),
         log_prices = log(cost_per_pack),
         log_tax = log(tax_dollar))

# Perform 2SLS regression using the total cigarette tax as an instrument for prices
iv_result <- ivreg(log_sales ~ log_prices | log_tax, data = filtered_data)

# Extract first stage and reduced-form results
first_stage <- summary(iv_result)$first.stage
reduced_form <- summary(iv_result)$reduced.form

# Output results
print(first_stage)
print(reduced_form)


```

\vspace{.2in}
\noindent 9.Repeat questions 1-3 focusing on the period from 1991 to 2015.<br>
```{r,  echo = FALSE}
library(ggplot2)
library(dplyr)

# Filter data for the years 1991 to 2015
filtered_data <- final.data %>%
  filter(Year >= 1991 & Year <= 2015)

# Calculate the proportion of states with a change in cigarette tax for each year
tax_change_counts <- filtered_data %>%
  group_by(Year) %>%
  summarize(states_with_change = sum(!is.na(tax_dollar)))

total_states <- length(unique(filtered_data$state))

tax_change_counts <- tax_change_counts %>%
  mutate(proportion = states_with_change / total_states)

# Plotting
ggplot(tax_change_counts, aes(x = factor(Year), y = proportion)) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(title = "Proportion of States with Cigarette Tax Changes (1991-2015)",
       x = "Year",
       y = "Proportion of States") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

```

```{r}
library(ggplot2)
library(dplyr)

# Filter data for the years 1991 to 2015
filtered_data <- final.data %>%
  filter(Year >= 1991 & Year <= 2015)

# Calculate average tax and average price for each year
average_tax <- filtered_data %>%
  group_by(Year) %>%
  summarize(avg_tax_2012 = mean(tax_dollar * (218 / index)))

average_price <- filtered_data %>%
  group_by(Year) %>%
  summarize(avg_price = mean(cost_per_pack))

# Combine the datasets
combined_data <- merge(average_tax, average_price, by = "Year")

# Plotting
ggplot(combined_data, aes(x = Year)) +
  geom_line(aes(y = avg_tax_2012, color = "Average Tax (2012 dollars)")) +
  geom_line(aes(y = avg_price, color = "Average Price of a Pack")) +
  scale_color_manual(values = c("Average Tax (2012 dollars)" = "blue", "Average Price of a Pack" = "red")) +
  labs(title = "Average Tax and Price of Cigarettes (1991-2015)",
       y = "Average Amount",
       color = "Variable") +
  theme_minimal()

```

```{r}
library(ggplot2)
library(dplyr)

# Calculate price increases for each state over the time period
price_increase <- final.data %>%
  filter(Year >= 1991 & Year <= 2015) %>%
  group_by(state) %>%
  summarize(price_increase = max(cost_per_pack) - min(cost_per_pack))

# Select top 5 states with the highest price increases
top_5_states <- price_increase %>%
  arrange(desc(price_increase)) %>%
  head(5)

# Filter data to include only the top 5 states
filtered_data <- final.data %>%
  filter(state %in% top_5_states$state)

# Plot average number of packs sold per capita for the top 5 states
ggplot(filtered_data, aes(x = Year, y = sales_per_capita, group = state, color = state)) +
  geom_line() +
  labs(title = "Average Packs Sold Per Capita for States with Highest Price Increases (1991-2015)",
       x = "Year",
       y = "Average Packs Sold Per Capita",
       color = "State") +
  theme_minimal()

```

\vspace{.2in}
\noindent 10.Compare your elasticity estimates from 1970-1990 versus those from 1991-2015. Are they different? If so, why?<br>
```{r,  echo = FALSE}
library(dplyr)

# Filter data for the time period from 1970 to 1990
filtered_data_1970_1990 <- final.data %>%
  filter(Year >= 1970 & Year <= 1990)

# Log transformation of sales and prices
filtered_data_1970_1990 <- filtered_data_1970_1990 %>%
  mutate(log_sales = log(sales_per_capita),
         log_prices = log(cost_per_pack))

# Perform linear regression
lm_result_1970_1990 <- lm(log_sales ~ log_prices, data = filtered_data_1970_1990)

# Extract elasticity coefficient
elasticity_1970_1990 <- coef(lm_result_1970_1990)[2]

# Print elasticity estimate
cat("Price elasticity of demand for cigarettes (1970-1990):", round(elasticity_1970_1990, 4), "\n")
```

```{r}
# Filter data for the time period from 1991 to 2015
filtered_data_1991_2015 <- final.data %>%
  filter(Year >= 1991 & Year <= 2015)

# Log transformation of sales and prices
filtered_data_1991_2015 <- filtered_data_1991_2015 %>%
  mutate(log_sales = log(sales_per_capita),
         log_prices = log(cost_per_pack))

# Perform linear regression
lm_result_1991_2015 <- lm(log_sales ~ log_prices, data = filtered_data_1991_2015)

# Extract elasticity coefficient
elasticity_1991_2015 <- coef(lm_result_1991_2015)[2]

# Print elasticity estimate
cat("Price elasticity of demand for cigarettes (1991-2015):", round(elasticity_1991_2015, 4), "\n")

```

```{r}
# Calculate difference in elasticity estimates
elasticity_difference <- elasticity_1991_2015 - elasticity_1970_1990

# Print comparison
cat("Difference in elasticity estimates between 1991-2015 and 1970-1990:", round(elasticity_difference, 4), "\n")

```
